# DDN模型流程图

## DDN模型在训练流程中的作用

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            DDN模型流程图                                    │
└─────────────────────────────────────────────────────────────────────────────┘

训练阶段概览:
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  数据输入    │───▶│  DDN归一化   │───▶│   WXM模型   │───▶│ DDN反归一化  │
│input_sequence│    │  normalize  │     │    预测     │      │de-normalize│
└─────────────┘     └─────────────┘     └─────────────┘     └─────────────┘
```

## 详细DDN处理流程

### 1. DDN模型初始化阶段
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            DDN模型初始化                                    │
└─────────────────────────────────────────────────────────────────────────────┘

utils/dynamic_exp.py: DynamicExp.__init__()
├── 检查配置: args.use_ddn_normalization
├── 如果启用DDN:
│   ├── 创建DDN模型: self.ddn_model = DDN(args)
│   ├── 移动到设备: .to(self.device)
│   ├── 创建DDN优化器: self.station_optim = Adam(ddn_model.parameters())
│   └── 设置学习率: args.station_lr
└── 如果未启用: self.ddn_model = None

models/DDN.py: DDN.__init__()
├── 初始化小波变换参数
├── 设置可学习参数
├── 初始化归一化层
└── 配置平稳性检测
```

### 2. DDN训练阶段 (预训练阶段)
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            DDN预训练阶段                                    │
└─────────────────────────────────────────────────────────────────────────────┘

训练循环: epoch <= station_pretrain_epoch (默认5个epoch)

┌─────────────────┐
│  输入序列       │  ← [batch_size, seq_len, 1]
│input_sequence   │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│ DDN归一化       │  ← ddn_model.normalize()
│ • 小波变换      │
│ • 统计量计算    │
│ • 平稳性检测    │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│ 统计量预测      │  ← statistics_pred [batch_size, seq_len, 2]
│ • 均值预测      │
│ • 标准差预测    │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│ 统计损失计算    │  ← station_loss()
│ • 真实统计量    │
│ • 预测统计量    │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│ 反向传播        │  ← station_optim.step()
│ • 更新DDN参数   │
│ • 不更新WXM参数 │
└─────────────────┘
```

### 3. DDN+WXM联合训练阶段
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          DDN+WXM联合训练                                    │
└─────────────────────────────────────────────────────────────────────────────┘

训练循环: epoch > station_pretrain_epoch

┌─────────────────┐
│  输入序列       │  ← [batch_size, seq_len, 1]
│input_sequence   │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│ DDN归一化       │  ← ddn_model.normalize()
│ • 小波变换      │
│ • 统计量计算    │
│ • 平稳性检测    │
│ 输出: normalized_sequence, statistics_pred │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│ WXM模型预测     │  ← model(normalized_sequence, ...)
│ • 多模态融合    │
│ • 序列预测      │
│ 输出: predictions │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│ DDN反归一化     │  ← ddn_model.de_normalize()
│ • 逆小波变换    │
│ • 恢复原始尺度  │
│ 输出: final_predictions │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│ 损失计算        │  ← criterion(final_predictions, target)
│ • MAE/MSE损失   │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│ 反向传播        │  ← optimizer.step() + station_optim.step()
│ • 更新WXM参数   │
│ • 更新DDN参数   │
└─────────────────┘
```

### 4. DDN模型核心组件

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            DDN模型组件                                      │
└─────────────────────────────────────────────────────────────────────────────┘

models/DDN.py: DDN类
├── normalize() 方法
│   ├── 小波变换 (utils/learnable_wavelet.py)
│   ├── 统计量计算 (均值、标准差)
│   ├── 平稳性检测 (utils/ADF.py)
│   └── 归一化处理
├── de_normalize() 方法
│   ├── 逆小波变换
│   ├── 统计量恢复
│   └── 反归一化处理
└── 可学习参数
    ├── 小波系数
    ├── 归一化参数
    └── 平稳性阈值

utils/learnable_wavelet.py
├── 可学习小波变换
├── 小波系数优化
└── 信号分解与重构

utils/ADF.py
├── ADF平稳性测试
├── 平稳性判断
└── 统计显著性检验
```

### 5. DDN在验证和测试阶段的作用

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        验证和测试阶段                                      │
└─────────────────────────────────────────────────────────────────────────────┘

验证阶段 (validate):
┌─────────────────┐
│  输入序列       │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│ DDN归一化       │  ← 与训练阶段相同
│ (p_value=False) │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│ WXM预测         │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│ DDN反归一化     │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│ 损失计算        │
└─────────────────┘

测试阶段 (test):
┌─────────────────┐
│  输入序列       │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│ 保存原始值      │  ← 重要：在DDN归一化前保存
│current_values   │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│ DDN归一化       │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│ WXM预测         │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│ DDN反归一化     │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│ 结果保存        │  ← predictions, true_values, current_values
└─────────────────┘
```

### 6. DDN模型保存和加载

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           模型保存机制                                      │
└─────────────────────────────────────────────────────────────────────────────┘

训练完成后:
┌─────────────────┐
│ 保存WXM模型     │  ← models/WXM_dynamic.pth
│model.state_dict()│
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│ 保存DDN模型     │  ← models/DDN_dynamic.pth (如果启用DDN)
│ddn_model.state_dict()│
└─────────────────┘

推理时加载:
┌─────────────────┐
│ 加载WXM模型     │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│ 加载DDN模型     │  ← 如果训练时使用了DDN
└─────────────────┘
```

## DDN模型的关键作用

### 1. **数据预处理作用**
- **小波变换**: 将时间序列分解为不同频率成分
- **统计归一化**: 计算并应用统计量进行归一化
- **平稳性检测**: 确保时间序列的平稳性

### 2. **训练稳定性作用**
- **预训练阶段**: 先训练DDN模型学习数据分布
- **联合训练**: DDN和WXM模型协同优化
- **梯度稳定**: 通过归一化减少梯度爆炸/消失

### 3. **预测精度作用**
- **尺度恢复**: 通过反归一化恢复原始预测尺度
- **统计一致性**: 保持预测结果的统计特性
- **误差控制**: 减少归一化带来的累积误差

### 4. **配置参数说明**

| 参数 | 作用 | 默认值 |
|------|------|--------|
| `use_ddn_normalization` | 是否启用DDN | True |
| `pre_epoch` | DDN预训练轮数 | 5 |
| `station_lr` | DDN学习率 | 0.0001 |
| `wavelet` | 小波类型 | 'coif3' |
| `learnable` | 是否可学习 | False |
| `use_norm` | 归一化类型 | 'sliding' |

## 使用示例

```python
# 启用DDN的训练命令
python train_new.py --config configs/config.yaml --task_type dynamic

# 配置文件中DDN相关设置
ddn:
  use_ddn_normalization: true
  pre_epoch: 5
  station_lr: 0.0001
  wavelet: 'coif3'
  learnable: false
  use_norm: 'sliding'
``` 