# 快速开始指南

## 环境准备

### 1. 安装依赖
```bash
pip install -r requirements.txt
```

### 2. 检查数据
确保以下数据文件存在：
- `data/activity_order_independent_id/` - 原始活动订单数据
- `data/all_activities_attributes.csv` - 活动属性数据

## 快速开始

### 1. 静态预测（预测活动总体表现）

```bash
# 使用默认配置进行静态预测
python train_new.py --task_type static

# 如果需要重新处理数据
python train_new.py --task_type static --process_data
```

### 2. 动态预测（预测时间序列表现）

```bash
# 使用默认配置进行动态预测
python train_new.py --task_type dynamic

# 如果需要重新处理数据
python train_new.py --task_type dynamic --process_data
```

### 3. 使用自定义配置

```bash
# 使用自定义配置文件
python train_new.py --config configs/my_config.yaml --task_type static
```

## 配置参数

### 主要配置项

编辑 `configs/config.yaml` 文件来调整参数：

```yaml
# 数据配置
data:
  freq: "d"                    # 数据频率：h(小时), d(日), w(周), m(月)
  target: "uc"                 # 动态预测目标：oc(订单量), uc(用户量)
  static_target: "user_sum"    # 静态预测目标：oc_sum, user_sum

# 模型配置
model:
  embedding_dim: 32            # 嵌入维度
  d_model: 128                # 模型维度
  dropout: 0.4                # Dropout率

# 训练配置
training:
  batch_size: 8               # 批次大小
  static_epochs: 1            # 静态预测轮数
  dynamic_epochs: 100         # 动态预测轮数
  static_learning_rate: 0.001 # 静态预测学习率
  dynamic_learning_rate: 0.1  # 动态预测学习率

# 序列配置
sequence:
  current_seq_len: 14         # 当前序列长度
  predict_seq_len: 7          # 预测序列长度
  total_seq_len: 30           # 总序列长度
```

### 特征配置

```yaml
features:
  use_img: false              # 是否使用图像特征
  use_text_attributes: true   # 是否使用文本属性
  use_label_attributes: true  # 是否使用标签属性
  use_numeric_attributes: true # 是否使用数值属性
  use_temporal_features: true # 是否使用时间特征
  use_current_seq: true       # 是否使用当前序列
```

## 监控训练

### 使用TensorBoard

```bash
# 启动TensorBoard
tensorboard --logdir runs

# 在浏览器中打开 http://localhost:6006
```

### 查看结果

训练结果保存在以下目录：
- `results/static/` - 静态预测结果
- `results/dynamic/` - 动态预测结果
- `models/` - 训练好的模型权重

## 预测新活动

```bash
# 使用训练好的模型进行预测
python forecast.py
```

## 常见问题

### 1. 数据集不存在
```
错误：数据集文件不存在: data/dataset_df.csv
解决：运行 python train_new.py --process_data
```

### 2. GPU内存不足
```
解决：在config.yaml中减小batch_size或d_model
```

### 3. 依赖包缺失
```
解决：运行 pip install -r requirements.txt
```

### 4. 配置文件错误
```
解决：检查configs/config.yaml的YAML语法
```

### 5. 数据处理错误
```
错误：CSV文件解析失败
解决：检查原始数据文件格式，程序会自动尝试多种读取方式
```

## 高级用法

### 1. 自定义数据处理

```python
from utils.data_processor import DataProcessor, UnifiedDataset

# 创建数据处理器
processor = DataProcessor(config)

# 处理原始数据
processor.process_activities(
    original_data_path="data/activity_order_independent_id",
    historical_activities_path="data",
    freq="d"
)

# 创建数据集
dataset = UnifiedDataset(
    data_df=df,
    config=config,
    task_type='static',
    mode='train'
)
```

### 2. 使用实验类

```python
from utils.static_exp import StaticExp
from utils.dynamic_exp import DynamicExp

# 静态预测实验
static_exp = StaticExp(args)
predictions, true_values = static_exp.run(train_loader, test_loader)

# 动态预测实验
dynamic_exp = DynamicExp(args)
predictions, true_values = dynamic_exp.run(train_loader, test_loader)
```

### 3. 项目清理

```bash
# 清理冗余文件和缓存
python scripts/cleanup.py

# 测试参数兼容性
python scripts/test_parameter_compatibility.py
```

### 4. 自动化依赖检查

```bash
# 生成实际使用的依赖
pip install pipreqs
pipreqs . --force --ignore test_ipynb,docs,assets,results

# 检查未使用的依赖
pip install pip-check-reqs
pip-missing-reqs .

# 检查未使用的代码
pip install vulture
vulture utils/
```

## 性能优化建议

1. **数据预处理**：
   - 使用 `--process_data` 一次性处理数据
   - 避免重复处理相同数据
   - 大数据集时注意文件大小限制（默认跳过100MB以上文件）

2. **内存管理**：
   - 根据GPU内存调整batch_size
   - 使用梯度累积处理大批次
   - 定期清理results/和runs/目录

3. **训练效率**：
   - 使用TensorBoard监控训练过程
   - 设置合适的早停参数
   - 使用配置文件管理参数，避免修改代码

4. **模型选择**：
   - 静态预测：适合总体表现评估
   - 动态预测：适合详细时间序列分析

5. **代码维护**：
   - 定期运行cleanup.py清理项目
   - 使用参数兼容性测试脚本
   - 及时更新requirements.txt

## 调试技巧

### 1. 数据检查
```python
# 检查数据集信息
print(f"数据集大小: {len(dataset_df)} 行")
print(f"特征数量: {len(dataset_df.columns)}")
print(f"缺失值情况: {dataset_df.isnull().sum().sum()}")
```

### 2. 模型检查
```python
# 检查模型参数
print(f"模型参数数量: {sum(p.numel() for p in model.parameters())}")
print(f"可训练参数: {sum(p.numel() for p in model.parameters() if p.requires_grad)}")
```

### 3. 训练监控
```bash
# 实时查看训练日志
tail -f runs/experiment_name/events.out.tfevents.*

# 检查GPU使用情况
nvidia-smi
```

## 下一步

1. 阅读 `docs/项目结构说明.md` 了解详细架构
2. 查看 `docs/实验记录.md` 了解实验结果
3. 根据需要调整配置文件
4. 在 `test_ipynb/` 目录中进行实验和调试
5. 开始您的实验！ 