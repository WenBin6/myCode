# 多模态活动预测系统 - 训练流程图

## 整体训练流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                             训练流程概览                                    │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  开始训练   │───▶│ 加载配置文件 │───▶│  参数转换   │───▶│ 数据处理阶段 │
│ train_new.py│    │config.yaml  │    │convert_args │    │DataProcessor│
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                              │
                                                              ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  训练完成   │◀───│  结果保存   │◀───│  实验执行   │◀───│  模型初始化 │
│             │    │  results/   │    │Static/Dynamic│    │   WXM模型   │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘

详细流程：
1. 配置加载 → 2. 数据处理 → 3. 模型构建 → 4. 实验执行 → 5. 结果保存
```

## 详细流程图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                             详细训练流程图                                  │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────┐
│   train_new.py  │  ← 主训练入口
│   (主入口文件)   │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│ configs/config.yaml │  ← 配置文件
│   (所有参数)     │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│ utils/data_processor.py │  ← 数据处理模块
│   DataProcessor  │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│  数据源文件     │
│ • activity_order_independent_id/ │
│ • all_activities_attributes*.csv │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│ UnifiedDataset  │  ← PyTorch数据集
│ (统一数据集)     │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   models/WXM.py │  ← 主模型
│     (WXM模型)   │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│ 任务类型判断    │
│ • static  → StaticExp │
│ • dynamic → DynamicExp│
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│ utils/static_exp.py  │  ← 静态实验
│ utils/dynamic_exp.py │  ← 动态实验
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│   results/      │  ← 结果保存
│ • static/       │
│ • dynamic/      │
└─────────────────┘
```

## 详细文件调用关系

### 1. 配置加载阶段
```
train_new.py (主入口)
├── load_config() → configs/config.yaml
├── convert_config_to_args() → 参数转换
└── 设置随机种子和GPU
```

### 2. 数据处理阶段

#### 2.1 DataProcessor.process_activities() - 活动数据处理

**功能**: 处理原始订单数据，生成活动统计数据

**输入文件**:
- `data/activity_order_independent_id/*.csv` - 原始订单数据文件
  - 必需列: `create_date`, `activity_name`, `id`, `user_id`
  - 文件大小限制: < 100MB

**输出文件**:
- `data/activity_order_independent_id_{freq}/*.csv` - 按频率聚合的数据
- `data/activities_duration_{freq}.csv` - 活动持续时间统计

**处理规则**:
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        process_activities 处理流程                          │
└─────────────────────────────────────────────────────────────────────────────┘

输入: 原始订单CSV文件
┌─────────────────┐
│ 原始订单数据    │  ← data/activity_order_independent_id/*.csv
│ • create_date   │
│ • activity_name │
│ • id            │
│ • user_id       │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│ 文件验证        │  ← 检查文件大小、必需列、编码格式
│ • 大小检查      │
│ • 列检查        │
│ • 编码处理      │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│ 数据聚合        │  ← 按频率聚合 (h/d/w/m)
│ • 时间重采样    │
│ • 统计计算      │
│ • 缺失值填充    │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│ 输出文件        │  ← 聚合数据和统计信息
│ • 聚合数据      │
│ • 活动统计      │
└─────────────────┘

频率映射规则:
h → 小时聚合 (H)
d → 日聚合 (D) 
w → 周聚合 (W)
m → 月聚合 (ME)

统计计算:
• oc: 订单数量 (id列计数)
• uc: 用户数量 (user_id列去重计数)
```

#### 2.2 DataProcessor.create_dataset() - 数据集创建

**功能**: 根据任务类型创建静态或动态预测数据集

**输入文件**:
- `data/activity_order_independent_id_{freq}/*.csv` - 聚合后的序列数据
- `data/activities_duration_{freq}.csv` - 活动持续时间统计
- `data/all_activities_attributes_threshold.csv` - 活动属性数据

**输出文件**:
- `data/dataset_df.csv` - 统一格式的数据集

**静态预测数据集创建流程**:
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        静态预测数据集创建                                   │
└─────────────────────────────────────────────────────────────────────────────┘

输入文件:
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│ 活动持续时间    │  │ 活动属性数据    │  │ 聚合序列数据    │
│activities_duration│ │all_activities_  │  │activity_order_  │
│_{freq}.csv      │  │attributes_      │  │independent_id_  │
└─────────┬───────┘  │threshold.csv    │  │{freq}/*.csv     │
          │          └─────────┬───────┘  └─────────────────┘
          │                    │
          └─────────┬──────────┘
                    │
                    ▼
┌─────────────────┐
│ 生成活动ID列表  │  ← 从activities_duration提取唯一activity_id
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│ 属性数据合并    │  ← 合并活动属性和持续时间统计
│ • 去除重复列    │
│ • 左连接合并    │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│ 数据排序        │  ← 按activity_start_time排序
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│ 输出数据集      │  ← 包含所有特征的活动数据集
└─────────────────┘
```

**动态预测数据集创建流程**:
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        动态预测数据集创建                                   │
└─────────────────────────────────────────────────────────────────────────────┘

输入文件:
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│ 活动持续时间    │  │ 活动属性数据    │  │ 聚合序列数据    │
│activities_duration│ │all_activities_  │  │activity_order_  │
│_{freq}.csv      │  │attributes_      │  │independent_id_  │
└─────────┬───────┘  │threshold.csv    │  │{freq}/*.csv     │
          │          └─────────┬───────┘  └─────────┬───────┘
          │                    │                    │
          └─────────┬──────────┴──────────┬─────────┘
                    │                     │
                    ▼                     ▼
┌─────────────────┐              ┌─────────────────┐
│ 生成活动ID列表  │              │ 序列数据处理    │
└─────────┬───────┘              │ • 长度检查      │
          │                      │ • 序列提取      │
          │                      │ • 形状重塑      │
          │                      └─────────┬───────┘
          │                               │
          └─────────┬─────────────────────┘
                    │
                    ▼
┌─────────────────┐
│ 属性数据合并    │  ← 合并活动属性和持续时间统计
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│ 序列特征合并    │  ← 将序列数据作为特征列
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│ 数据排序        │  ← 按activity_start_time排序
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│ 输出数据集      │  ← 包含序列和特征的数据集
└─────────────────┘

序列处理规则:
• 序列长度检查: activity_length >= current_days + predict_days
• 序列提取: sequence_array[:current_days + predict_days]
• 形状重塑: reshape(1, -1) 作为特征列
```

#### 2.3 UnifiedDataset - 统一数据集类

**功能**: PyTorch数据集类，处理多模态特征

**输入**: 处理后的DataFrame
**输出**: 模型训练所需的张量数据

**特征处理流程**:
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           UnifiedDataset 处理流程                           │
└─────────────────────────────────────────────────────────────────────────────┘

输入: 处理后的DataFrame
┌─────────────────┐
│ 原始DataFrame   │  ← 包含所有特征的数据框
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│ 数据预处理      │  ← 异常值处理、特征编码、归一化
│ • 异常值去除    │
│ • 分类特征编码  │
│ • 特征归一化    │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│ 特征提取        │  ← 根据任务类型提取不同特征
│ • 数值特征      │
│ • 标签特征      │
│ • 时间特征      │
│ • 文本特征      │
│ • 序列特征      │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│ 张量转换        │  ← 转换为PyTorch张量
│ • 数据类型转换  │
│ • 形状调整      │
│ • 设备移动      │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐
│ 输出张量        │  ← 模型训练所需的所有张量
└─────────────────┘

特征提取规则:
数值特征: [activity_budget, max_reward_count, min_reward_count, duration]
标签特征: [customer_id, activity_type, activity_form, bank_name, location, 
          main_reward_type, secondary_reward_type, template_id, threshold]
时间特征: [day, week, month, year]
文本特征: {activity_name, activity_title, product_names}
序列特征: 动态预测时的输入序列和目标序列

处理规则:
• 静态预测: 序列特征为空，目标为标量值
• 动态预测: 分离输入序列和目标序列，目标为0.0
• 异常值处理: Z-score方法，阈值=3
• 特征编码: LabelEncoder编码分类特征
• 序列归一化: StandardScaler标准化
• 特征归一化: StandardScaler标准化数值特征
```

### 3. 模型构建阶段
```
models/WXM.py
├── WXM模型初始化
│   ├── 文本编码器 (BERT)
│   ├── 数值特征编码器
│   ├── 标签特征编码器
│   └── 时间特征编码器
├── 四通路跨模态注意力
├── 特征融合层
└── 输出层

models/DDN.py (可选)
├── DDN归一化模块
└── 可学习小波变换

layers/
├── RevIN.py (可逆归一化)
└── fds.py (特征分布标准化)
```

### 4. 实验执行阶段

#### 静态预测实验
```
utils/static_exp.py
├── StaticExp.run()
│   ├── 模型训练循环
│   ├── 损失计算 (分位数损失)
│   ├── 优化器更新
│   └── 验证评估
├── 性能指标计算
│   ├── MAE, MSE
│   └── 分位数损失
└── 结果可视化
```

#### 动态预测实验
```
utils/dynamic_exp.py
├── DynamicExp.run()
│   ├── 模型训练循环
│   ├── 序列预测
│   ├── 损失计算 (MAE/MSE)
│   └── 验证评估
├── 性能指标计算
│   ├── MAE, MSE, MAPE
│   └── 时间序列评估
└── 结果可视化
```

### 5. 工具支持模块
```
utils/tools.py
├── 通用工具函数
├── 数据预处理函数
└── 评估指标计算

utils/ADF.py
├── ADF平稳性测试
└── 时间序列分析

utils/learnable_wavelet.py
├── 可学习小波变换
└── 信号处理工具
```

### 6. 结果保存阶段
```
results/
├── static/
│   ├── 静态预测结果
│   ├── 性能指标
│   └── 可视化图表
└── dynamic/
    ├── 动态预测结果
    ├── 时间序列图
    ├── 预测vs真实值对比
    └── 性能指标
```

## 数据流向图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                             数据流向图                                      │
└─────────────────────────────────────────────────────────────────────────────┘

输入数据层:
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│  原始订单数据   │  │  活动属性数据   │  │  历史活动数据   │
│activity_order_  │  │all_activities_  │  │activities_      │
│independent_id/  │  │attributes*.csv  │  │duration_*.csv   │
└─────────┬───────┘  └─────────┬───────┘  └─────────┬───────┘
          │                    │                    │
          └─────────┬──────────┴──────────┬─────────┘
                    │                     │
                    ▼                     ▼
数据处理层:
┌─────────────────┐              ┌─────────────────┐
│  DataProcessor  │─────────────▶│  UnifiedDataset │
│  (数据预处理)   │              │  (PyTorch数据集)│
└─────────┬───────┘              └─────────┬───────┘
          │                               │
          ▼                               ▼
模型架构层:
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│   DDN归一化     │  │   RevIN层      │  │   WXM模型       │
│  (可选模块)     │  │  (可逆归一化)   │  │  (主模型)       │
└─────────┬───────┘  └─────────┬───────┘  └─────────┬───────┘
          │                    │                    │
          └─────────┬──────────┴──────────┬─────────┘
                    │                     │
                    ▼                     ▼
实验执行层:
┌─────────────────┐              ┌─────────────────┐
│   StaticExp     │              │   DynamicExp    │
│  (静态预测)     │              │  (动态预测)     │
└─────────┬───────┘              └─────────┬───────┘
          │                               │
          ▼                               ▼
结果输出层:
┌─────────────────┐              ┌─────────────────┐
│  静态预测结果   │              │  动态预测结果   │
│  results/static/│              │ results/dynamic/│
└─────────────────┘              └─────────────────┘

数据流向说明:
原始数据 → 数据预处理 → 特征工程 → 模型训练 → 结果输出
```

## 关键文件说明

| 文件/目录 | 作用 | 主要类/函数 |
|-----------|------|-------------|
| `train_new.py` | 主训练入口 | `main()`, `run_training()` |
| `configs/config.yaml` | 配置文件 | 所有训练参数 |
| `utils/data_processor.py` | 数据处理 | `DataProcessor`, `UnifiedDataset` |
| `models/WXM.py` | 主模型 | `WXM` |
| `models/DDN.py` | DDN归一化 | `DDN` |
| `utils/static_exp.py` | 静态实验 | `StaticExp` |
| `utils/dynamic_exp.py` | 动态实验 | `DynamicExp` |
| `layers/RevIN.py` | 可逆归一化 | `RevIN` |
| `layers/fds.py` | 特征标准化 | `FDS` |
| `utils/tools.py` | 通用工具 | 各种工具函数 |
| `results/` | 结果保存 | 训练结果和可视化 |

## 训练命令示例

```bash
# 静态预测训练
python train_new.py --config configs/config.yaml --task_type static

# 动态预测训练
python train_new.py --config configs/config.yaml --task_type dynamic

# 重新处理数据并训练
python train_new.py --config configs/config.yaml --task_type static --process_data
``` 